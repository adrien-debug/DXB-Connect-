---
description: Standards React Query hooks et composants
globs: "**/src/{hooks,components}/**/*.{ts,tsx}"
alwaysApply: false
---

# React Query & Hooks - Standards

## ðŸŽ£ Structure Hook Custom

```typescript
// âœ… Pattern standard dans src/hooks/
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { createClient } from '@/lib/supabase/client';

export function useResource() {
  const supabase = createClient();
  const queryClient = useQueryClient();

  // Query
  const { data, isLoading, error } = useQuery({
    queryKey: ['resource'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('table')
        .select('*');

      if (error) throw error;
      return data;
    },
  });

  // Mutation
  const createMutation = useMutation({
    mutationFn: async (payload: CreatePayload) => {
      const { data, error } = await supabase
        .from('table')
        .insert(payload)
        .select()
        .single();

      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['resource'] });
    },
  });

  return {
    data,
    isLoading,
    error,
    create: createMutation.mutate,
    isCreating: createMutation.isPending,
  };
}
```

## ðŸ”‘ Query Keys

```typescript
// âœ… BON - HiÃ©rarchie claire
['esim', 'orders']                    // Liste orders
['esim', 'orders', orderId]           // Order spÃ©cifique
['esim', 'orders', { status: 'active' }]  // FiltrÃ©

// âŒ MAUVAIS
['orders']                            // Trop vague
['getOrders']                         // Pas de verbe
```

## ðŸ”„ Invalidation Cache

```typescript
// âœ… Invalider aprÃ¨s mutation
onSuccess: () => {
  // Invalide toutes les queries commenÃ§ant par ['esim']
  queryClient.invalidateQueries({ queryKey: ['esim'] });

  // OU spÃ©cifique
  queryClient.invalidateQueries({ queryKey: ['esim', 'orders'] });
}
```

## ðŸŽ¨ Composants React

### Structure Composant
```tsx
// âœ… Pattern standard
interface Props {
  title: string;
  onAction?: () => void;
}

export function Component({ title, onAction }: Props) {
  const [state, setState] = useState<Type>(initialValue);
  const { data, isLoading } = useCustomHook();

  if (isLoading) return <div>Loading...</div>;

  return (
    <div className="space-y-4">
      <h2 className="text-xl font-bold">{title}</h2>
      {/* contenu */}
    </div>
  );
}
```

### Gestion Erreurs
```tsx
// âœ… Affichage erreur user-friendly
if (error) {
  return (
    <div className="p-4 bg-red-50 text-red-600 rounded">
      Une erreur est survenue. Veuillez rÃ©essayer.
    </div>
  );
}

// âŒ Ne JAMAIS afficher error.message brut (peut contenir infos sensibles)
```

## ðŸ” Auth dans Hooks

```typescript
// âœ… VÃ©rifier auth dans hooks API
export function useProtectedResource() {
  return useQuery({
    queryKey: ['protected'],
    queryFn: async () => {
      const response = await fetch('/api/resource', {
        headers: {
          'Authorization': `Bearer ${getToken()}`,  // âœ… Token depuis storage
        },
      });

      if (!response.ok) throw new Error('Unauthorized');
      return response.json();
    },
  });
}
```

## ðŸ“± Hooks eSIM SpÃ©cifiques

### Pattern useEsimAccess
```typescript
// âœ… Hooks dans src/hooks/useEsimAccess.ts
export function useEsimOrders() {
  return useQuery({
    queryKey: ['esim', 'orders'],
    queryFn: async () => {
      const response = await fetch('/api/esim/orders', {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      const { esimList } = await response.json();  // âœ… Respecter shape API
      return esimList;
    },
  });
}
```

## ðŸ§ª Tests Composants

```typescript
// âœ… Test basique avec Testing Library
import { render, screen } from '@testing-library/react';

describe('Component', () => {
  it('renders title', () => {
    render(<Component title="Test" />);
    expect(screen.getByText('Test')).toBeInTheDocument();
  });
});
```

## ðŸŽ¯ Best Practices

1. **Un hook = une responsabilitÃ©**
2. **Toujours typer les retours**
3. **GÃ©rer loading/error states**
4. **Invalider cache aprÃ¨s mutations**
5. **Ne jamais exposer erreurs techniques au user**
