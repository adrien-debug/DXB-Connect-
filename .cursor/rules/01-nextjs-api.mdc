---
description: Standards API Next.js pour routes backend
globs: **/app/api/**/*.ts
alwaysApply: false
---

# API Routes Next.js - Standards

## ğŸ” Authentification

### Fonction UnifiÃ©e (iOS + Web)
```typescript
// âœ… TOUJOURS utiliser requireAuthFlexible
import { requireAuthFlexible } from '@/lib/auth-middleware';

export async function GET(request: Request) {
  const { user, error } = await requireAuthFlexible(request);
  if (error) return NextResponse.json({ error }, { status: 401 });

  // user.id disponible
}
```

### Types d'Auth SupportÃ©s
- **Bearer Token**: `Authorization: Bearer <token>` (iOS)
- **Cookie Session**: Session Supabase (Web)

## ğŸ“‹ Structure Route

```typescript
// âœ… BON - Structure complÃ¨te
export async function POST(request: Request) {
  try {
    // 1. Auth
    const { user, error } = await requireAuthFlexible(request);
    if (error) return NextResponse.json({ error }, { status: 401 });

    // 2. Validation
    const body = await request.json();
    const validated = schema.parse(body);

    // 3. VÃ©rification ownership
    const { data } = await supabase
      .from('table')
      .select()
      .eq('id', validated.id)
      .eq('user_id', user.id)  // âœ… CRITIQUE
      .single();

    if (!data) return NextResponse.json(
      { error: 'Not found or unauthorized' },
      { status: 404 }
    );

    // 4. Logique mÃ©tier
    const result = await doSomething(data);

    // 5. RÃ©ponse
    return NextResponse.json({ data: result });

  } catch (error) {
    // âŒ Ne JAMAIS logger error.message directement (peut contenir secrets)
    console.error('[API] Operation failed:', {
      endpoint: '/api/route',
      userId: user?.id,
      // Ne PAS logger: email, tokens, donnÃ©es sensibles
    });

    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

## ğŸš¨ SÃ©curitÃ© Critique

### âŒ INTERDIT
```typescript
// âŒ Accepter user_id du client
const { user_id } = await request.json();
await supabase.from('orders').select().eq('user_id', user_id);

// âŒ Logs avec donnÃ©es sensibles
console.log('User email:', user.email);
console.log('Token:', token);

// âŒ Erreurs dÃ©taillÃ©es en production
return NextResponse.json({ error: error.message }, { status: 500 });
```

### âœ… OBLIGATOIRE
```typescript
// âœ… user_id depuis auth
const { user } = await requireAuthFlexible(request);
await supabase.from('orders').select().eq('user_id', user.id);

// âœ… Logs sans donnÃ©es sensibles
console.error('[API] Failed:', { endpoint, userId: user.id });

// âœ… Erreurs gÃ©nÃ©riques
return NextResponse.json({ error: 'Operation failed' }, { status: 500 });
```

## ğŸ”„ Gestion Erreurs

```typescript
// âœ… Pattern standard
try {
  // logique
} catch (error) {
  if (error instanceof ZodError) {
    return NextResponse.json(
      { error: 'Invalid input', details: error.errors },
      { status: 400 }
    );
  }

  console.error('[API] Error:', {
    endpoint: request.url,
    method: request.method,
    userId: user?.id,
    // Ne PAS inclure: error.message, stack, donnÃ©es user
  });

  return NextResponse.json(
    { error: 'Internal server error' },
    { status: 500 }
  );
}
```

## ğŸ“Š Headers RÃ©ponse

```typescript
// âœ… Headers sÃ©curitÃ©
return NextResponse.json(data, {
  status: 200,
  headers: {
    'Cache-Control': 'private, no-cache',
    'X-Content-Type-Options': 'nosniff',
  },
});
```

## ğŸ§ª Validation Zod

```typescript
import { z } from 'zod';

const schema = z.object({
  iccid: z.string().length(19),
  amount: z.number().positive(),
});

// âœ… Valider avant utilisation
const validated = schema.parse(body);
```
