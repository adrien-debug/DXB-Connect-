---
description: Architecture de communication stricte - Railway Backend UNIQUEMENT
alwaysApply: true
---

# Architecture Railway - RÃˆGLE ABSOLUE

## ğŸ—ï¸ Architecture Stricte (NON NÃ‰GOCIABLE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DXB Connect Architecture                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   ğŸ“± iOS SwiftUI App          ğŸ’» Next.js Admin Web          â”‚
â”‚   (Client Mobile)             (Dashboard Admin)             â”‚
â”‚         â”‚                              â”‚                     â”‚
â”‚         â”‚                              â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â–¼                                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚              â”‚  ğŸš‚ Railway Backend â”‚ â—„â”€â”€ POINT CENTRAL      â”‚
â”‚              â”‚  (Next.js API)      â”‚                         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â–¼                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚              â”‚   ğŸ“Š Supabase       â”‚                         â”‚
â”‚              â”‚   (Database + Auth) â”‚                         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â–¼                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚              â”‚  ğŸ“¡ eSIM Access API â”‚                         â”‚
â”‚              â”‚  (Provider externe) â”‚                         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                              â”‚
â”‚   ğŸ‘¤ Client Final                                            â”‚
â”‚   â””â”€â–º AchÃ¨te et utilise via iOS/Web                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš« RÃˆGLES ABSOLUES - NE JAMAIS CHANGER

### âŒ STRICTEMENT INTERDIT

1. **Next.js NE communique JAMAIS directement avec** :
   - âŒ Supabase (sauf via Railway)
   - âŒ eSIM Access API (sauf via Railway)
   - âŒ Tout autre service externe

2. **iOS SwiftUI NE communique JAMAIS directement avec** :
   - âŒ Supabase
   - âŒ eSIM Access API
   - âŒ Tout autre backend que Railway

3. **NE JAMAIS** :
   - âŒ CrÃ©er de connexion directe client â†’ Supabase
   - âŒ CrÃ©er de connexion directe client â†’ eSIM API
   - âŒ Bypasser Railway pour "optimiser"
   - âŒ Ajouter d'autres backends

### âœ… OBLIGATOIRE - TOUJOURS

1. **Next.js (Admin Web)** :
   ```typescript
   // âœ… TOUJOURS passer par Railway
   const RAILWAY_API = process.env.NEXT_PUBLIC_RAILWAY_URL || 'https://api-github-production-a848.up.railway.app';

   // âœ… Toutes les requÃªtes passent par Railway
   fetch(`${RAILWAY_API}/api/esim/packages`)
   ```

2. **iOS SwiftUI** :
   ```swift
   // âœ… TOUJOURS pointer vers Railway
   case .production:
       return URL(string: "https://api-github-production-a848.up.railway.app/api")!

   // âŒ NE JAMAIS pointer ailleurs
   ```

3. **Railway Backend** :
   - âœ… Seul point d'entrÃ©e pour TOUS les clients
   - âœ… Seul Ã  communiquer avec Supabase
   - âœ… Seul Ã  communiquer avec eSIM Access API
   - âœ… GÃ¨re TOUTE la logique mÃ©tier

## ğŸ” Configuration Stricte

### Next.js - Variables d'environnement

```env
# âœ… OBLIGATOIRE - Railway Backend
NEXT_PUBLIC_RAILWAY_URL=https://api-github-production-a848.up.railway.app

# âŒ NE JAMAIS exposer cÃ´tÃ© client
# SUPABASE_URL et SUPABASE_KEY restent cÃ´tÃ© serveur Railway uniquement
```

### iOS SwiftUI - Config.swift

```swift
// âœ… Configuration FIXE - NE JAMAIS CHANGER
public static var baseURL: URL {
    switch current {
    case .development:
        // Dev local: Railway en local ou tunnel
        return URL(string: "http://localhost:4000/api")!

    case .staging:
        // Staging Railway
        return URL(string: "https://dxb-connect-staging.railway.app/api")!

    case .production:
        // âœ… PRODUCTION RAILWAY - NE JAMAIS CHANGER
        return URL(string: "https://api-github-production-a848.up.railway.app/api")!
    }
}
```

## ğŸ¯ Flux de DonnÃ©es STRICT

### Achat eSIM (Exemple)

```
1. Client iOS/Web
   â””â”€â–º POST /api/esim/purchase
       â””â”€â–º Railway Backend
           â”œâ”€â–º VÃ©rification auth (Supabase via Railway)
           â”œâ”€â–º Validation donnÃ©es
           â”œâ”€â–º Appel eSIM Access API (via Railway)
           â”œâ”€â–º Enregistrement order (Supabase via Railway)
           â””â”€â–º RÃ©ponse au client
```

### Consultation Packages

```
1. Client iOS/Web
   â””â”€â–º GET /api/esim/packages
       â””â”€â–º Railway Backend
           â”œâ”€â–º Cache check (Railway)
           â”œâ”€â–º Appel eSIM Access API (via Railway)
           â””â”€â–º RÃ©ponse au client
```

## ğŸ”’ SÃ©curitÃ© Railway

### Headers Requis (Client â†’ Railway)

```typescript
// âœ… Headers obligatoires
headers: {
  'Authorization': `Bearer ${token}`,      // Token Supabase
  'Content-Type': 'application/json',
  'X-Client-Platform': 'iOS' | 'Web',
  'X-Client-Version': '1.0.0',
}
```

### Validation Railway (Serveur)

```typescript
// âœ… Railway vÃ©rifie TOUT
export async function POST(request: Request) {
  // 1. VÃ©rifier token Supabase
  const { user, error } = await requireAuthFlexible(request);
  if (error) return NextResponse.json({ error }, { status: 401 });

  // 2. Valider donnÃ©es
  const validated = schema.parse(body);

  // 3. VÃ©rifier ownership
  const { data } = await supabase
    .from('table')
    .select()
    .eq('user_id', user.id)  // âœ… CRITIQUE
    .single();

  // 4. Appeler service externe (eSIM API)
  const result = await esimAccessAPI.call(validated);

  // 5. Enregistrer dans Supabase
  await supabase.from('esim_orders').insert({
    user_id: user.id,
    ...result
  });

  return NextResponse.json({ data: result });
}
```

## ğŸ“‹ Checklist Avant Toute Modification

Avant de modifier QUOI QUE CE SOIT :

- [ ] La modification respecte-t-elle l'architecture Railway ?
- [ ] Aucune connexion directe client â†’ Supabase ?
- [ ] Aucune connexion directe client â†’ eSIM API ?
- [ ] Toutes les requÃªtes passent par Railway ?
- [ ] Les secrets restent cÃ´tÃ© Railway uniquement ?

## âš ï¸ Exceptions (AUCUNE)

Il n'y a **AUCUNE exception** Ã  cette architecture.

MÃªme pour :
- âŒ "Optimisation" performance
- âŒ "RÃ©duire latence"
- âŒ "Simplifier le code"
- âŒ "Tests rapides"

**Railway est TOUJOURS le point d'entrÃ©e.**

## ğŸ¯ RÃ´les Clairs

| Composant | RÃ´le | Communique avec |
|-----------|------|-----------------|
| **iOS App** | Interface client mobile | Railway UNIQUEMENT |
| **Next.js Web** | Dashboard admin | Railway UNIQUEMENT |
| **Railway** | Backend API central | Supabase + eSIM API |
| **Supabase** | Database + Auth | Railway UNIQUEMENT |
| **eSIM API** | Provider externe | Railway UNIQUEMENT |
| **Client Final** | Utilisateur final | iOS/Web Apps |

## ğŸš¨ Si Quelqu'un Propose de Changer

Si quelqu'un (humain ou IA) propose :
- "Et si on connectait directement iOS Ã  Supabase ?"
- "On pourrait bypasser Railway pour cette requÃªte ?"
- "Ajoutons un autre backend pour..."

**RÃ©ponse : NON. Architecture Railway non nÃ©gociable.**

## ğŸ“ Documentation URLs

### URLs Production (NE JAMAIS CHANGER)

```bash
# Railway Backend (POINT CENTRAL)
https://api-github-production-a848.up.railway.app

# Endpoints API (via Railway)
https://api-github-production-a848.up.railway.app/api/esim/packages
https://api-github-production-a848.up.railway.app/api/esim/orders
https://api-github-production-a848.up.railway.app/api/auth/email/send-otp
```

### URLs Internes (Jamais exposÃ©es au client)

```bash
# Supabase (Railway â†’ Supabase uniquement)
https://xxx.supabase.co

# eSIM Access API (Railway â†’ eSIM uniquement)
https://api.esimaccess.com
```

## ğŸ”„ Workflow DÃ©veloppement

1. **DÃ©velopper feature** â†’ Toujours via Railway
2. **Tester** â†’ Pointer vers Railway (local ou staging)
3. **DÃ©ployer** â†’ Railway dÃ©ploie automatiquement
4. **Clients** â†’ Utilisent Railway en production

**Aucune Ã©tape ne bypasse Railway.**
